
(function(_root, _jvxAd, _dataset) {
   var widget = widget || {};
    widget.defaults = {
        adSize: dynamicData['campaignProperties:campaignProperties.creativeDim'],
        numberOfProducts: 4,
        productids : []
    }
    
    var strategy,default_strategy,geoValue,langValue,dspValuevar,category_value,gender_value;

    function arrayMaxRepeat(array) {
        if (array.length == 0)
            return null;
        var modeMap = {};
        var maxEl = array[0],
            maxCount = 1;
        for (var i = 0; i < array.length; i++) {
            var el = array[i];
            if (modeMap[el] == null)
                modeMap[el] = 1;
            else
                modeMap[el]++;
            if (modeMap[el] > maxCount) {
                maxEl = el;
                maxCount = modeMap[el];
            }
        }
        return maxEl;
    };
    function round5(x){
        return Math.floor(x/5)*5;
    }   

    function getMatch(a, b) { 
        var matches = [];

        for ( var i = 0; i < a.length; i++ ) {
            for ( var e = 0; e < b.length; e++ ) {
                if ( a[i] === b[e] ) matches.push( a[i] );
            }
        }
        return matches;
    }
    (function() {
        var self = this,
            productSet = [],
            productIds = [],
            ftw_count = [],
            app_count = [],
            getCatagory = [],
            getGender = [];
        this.getDynamicData = function(key) {
            if (typeof _dataset !== "undefined" && typeof _dataset[key] !== "undefined") return _dataset[key];
            else return false;
        }
        this.dynamicDataCallback = function(dbName, keyTrigger, callbackFn) {
            var responseString = jvxAd.assetDBReq(dbName).keys(keyTrigger).order("random").build();
            _jvxAd.dynamicDataCallback(callbackFn).get(responseString);
        }
        this.isRetargeting = function() {
            return JSON.parse(self.getDynamicData('cookieData:cookieData.jvxdynsl-isSet'));
        };
        this.generateGallery = function(result,creativeVariationReporting,customWidgetReporting) {
            console.log('generateGallery',result);

            var productReporting = [];
            var colorReporting = [];
            var modeltypeReporting = [];
            var product_colorReporting = [];
            var cat_Reporting = [];
            var gen_Reporting = [];
            var priority = creativeVariationReporting.split("_")[0];
            console.log("priorityVal",priority);

            switch (dynamicData['campaignProperties:campaignProperties.creativeDim']) {
                case '728x90':
                    var ftw_titleChar = 18,
                        app_titleChar = 18,
                        creativeDim = "728x90";
                    break;
                
                default:
                    var imageContainerWidth = 190,
                        imageContainerHeight = 95,
                        imageBottom = 74;
            }

            for(i=0;i<widget.defaults.numberOfProducts;i++){

                var cv_no = "NA";
                var color_code = result[i]['hexvalue_code'];
                var color_code_val = color_code;

                productReporting.push(result[i]['ID']);
            //    colorReporting.push(color_code_val);
                if(result[i]['model_type'] == "Footwear"){
                    modeltypeReporting.push("FTW");
                }else{
                    modeltypeReporting.push("APP");
                }

           //     product_colorReporting.push(result[i]['ID']+":"+color_code_val);
                cat_Reporting.push(result[i]['Category']);
                gen_Reporting.push(result[i]['Gender']);

                if(result[i]['model_type'] == 'Footwear'){
                    console.log('ftw____');
                    ftw_count.push(i);
                    var frame_val = i + 2,
                        frame_value = frame_val.toString();
                        index_val = i + 1,
                        index_value = "_"+index_val.toString();
                    document.getElementById('frame'+frame_value).classList.add("shoe");
                    console.log(index_value,'index_value');
                    document.getElementsByClassName('product'+index_value)[0].src = result[i]['Transparent_image1'];
                    document.getElementsByClassName('product'+index_value)[1].src = result[i]['Transparent_image5'];
                    document.getElementsByClassName('product'+index_value)[2].src = result[i]['Transparent_image3'];
                    document.getElementsByClassName("head")[i].innerHTML = dynamicData['NC_Head_CTA'][0]['Headline'];
                    if(ap_DataSignal7 == "russia_russian")
                    {
                        document.getElementsByClassName("head")[i].style.cssText+="font-size:9px";
                        document.getElementsByClassName("price")[i].style.cssText+="font-size:11px";  
                    }  
					if(ap_DataSignal7 == "denmark_danish" || ap_DataSignal7 == "sweden_swedish"|| ap_DataSignal7 == "norway_norwegian")
                    {
                        document.getElementsByClassName("price")[i].style.cssText+="font-size:11px";  
                    } 
                    if(ap_DataSignal7 == "switzerland_english" || ap_DataSignal7 =="switzerland_french" || ap_DataSignal7 =="switzerland_german" ||ap_DataSignal7 =="switzerland_italian")
                    {
                        document.getElementsByClassName("price")[i].style.cssText+="font-size:10.5px;padding:0 1px";  
                    }
                    document.getElementsByClassName("cta")[i].innerHTML = dynamicData['NC_Head_CTA'][0]['CTA'];
                     //kids
                     if(result[i]['Gender']=="YOUTH")
                     {
                         document.getElementsByClassName("kids-label")[i].style.cssText+="display:block";
                     }//kids
                     if(ap_DataSignal7 == "spain_spanish" || ap_DataSignal7 == "spain_catalan")
                     {
                         document.getElementsByClassName("cta")[i].style.cssText+="font-size:9px;padding: 4px 5px 4.5px;";
                         document.getElementsByClassName("head")[i].style.cssText+="top:27px";
                     } 
                     if(ap_DataSignal7 == "germany_german" || ap_DataSignal7 == "austria_german" || ap_DataSignal7 == "belgium_german" || ap_DataSignal7 == "italy_italian" || ap_DataSignal7 == "switzerland_italian" || ap_DataSignal7 =="switzerland_german"  ||  ap_DataSignal7 =="belgium_german")
                     {
                         document.getElementsByClassName("cta")[i].style.cssText+="font-size:11px;padding: 3px 6px 4px;";
                         document.getElementsByClassName("head")[i].style.cssText+="top:28px";
                     } 
                     if(ap_DataSignal7 == "sweden_swedish")
                     {
                        document.getElementsByClassName("cta")[i].style.cssText+="font-size:11px;padding: 3px 6px 4px;";
                        document.getElementsByClassName("head")[i].style.cssText+="top:28px";
                     }
                     var mac = "Mac";
                     if(navigator.userAgent.indexOf(mac) > -1)
                     {
                        document.getElementsByClassName("cta")[i].style.cssText+="padding:3px 6px 4.5px";
                     }
                   
                    var title_split = result[i]['style_line1'].split(" ");
                    var title_trim = result[i]['style_line1'].substring(0, ftw_titleChar);
                    var title_trim_1 = title_trim.split(" ");
                    var final_trim = [],
                        final_title_value = [];
                    if(title_trim_1.length > 0){
                        var trim_len = title_trim_1.length;
                        for(k=0;k<trim_len;k++){
                           final_trim.push(title_split[k]+" ");
                        }
                        var final_trim_V1 = final_trim.join(" ");
                        var final_trim_1 = final_trim_V1.trim();
                        if(final_trim_1.length > ftw_titleChar){
                            title_trim_1.pop();
                            for(l=0;l<title_trim_1.length;l++){
                               final_title_value.push(title_trim_1[l]+" ");
                            }
                            var ab___ = final_title_value.join(" ");
                            var final_title_val = ab___.trim();
                            console.log(result[i]['style_line1'].substring(0, ftw_titleChar),"____",final_title_val,"difference___ftw");
                            document.getElementsByClassName('title')[i].innerHTML = final_title_val;
                        }else{
                            document.getElementsByClassName('title')[i].innerHTML = result[i]['style_line1'].substring(0, ftw_titleChar);
                        }
                    }else{
                        document.getElementsByClassName('title')[i].innerHTML = result[i]['style_line1'].substring(0, ftw_titleChar);
                    }
                    for(j=0;j<3;j++){
                        var dbCont = result[i],
                        slideElem = document.getElementsByClassName("product"+index_value)[j];
                        console.log(slideElem,j,'______');

                        if(j==0){
                        var imageContainerWidth = 100,
                            imageContainerHeight = 54,
                            imageBottom = 20,
                            imageRight = 187,
                            image_value = '1';
                        }else if(j==1){
                            var imageContainerWidth = 100,
                                imageContainerHeight = 54,
                                imageBottom = 20,
                                imageRight = 318,
                                image_value = '3';
                        }else{
                            var imageContainerWidth = 100,
                                imageContainerHeight = 54,
                                imageBottom = 20,
                                imageRight = 447,
                                image_value = '5';
                        }
                
                        var imgWidth = parseInt(dbCont['width'+image_value]),
                            imgHeight = parseInt(dbCont['height'+image_value]),
                            imgTop = parseInt(dbCont['top_value'+image_value]),
                            imgBottom = parseInt(dbCont['bottom_value'+image_value]),
                            imgLeft = parseInt(dbCont['left_value'+image_value]),
                            imgRight = parseInt(dbCont['right_value'+image_value]),
                            imgTransparent = parseFloat(dbCont['Transparent_percent'+image_value]);
                
                        var productWidth = (imgWidth - (imgRight + imgLeft)),
                            productHeight = (imgHeight - (imgTop + imgBottom));
                            console.log(productWidth,productHeight,'width');
                        var unitWidth = dynamicData['campaignProperties:campaignProperties.creativeDim'].split('x')[0],
                            unitHeight = dynamicData['campaignProperties:campaignProperties.creativeDim'].split('x')[1];

                        slideElem.style.height = (imageContainerHeight*imgHeight)/productHeight + "px";
                        slideElem.style.width = (imageContainerHeight*imgHeight)/productHeight + "px";
                            var elemWidth = slideElem.width;
                            var rightTrans = ((imgRight * 100)/imgWidth);
                            var croppedRight = ((rightTrans * elemWidth)/100);
                            var leftTrans = ((imgLeft * 100)/imgWidth);
                            var croppedLeft = ((leftTrans * elemWidth)/100);
                            var actualWidth = (elemWidth - (croppedRight + croppedLeft));
                        
                        if(imageContainerWidth < actualWidth){
                            slideElem.style.height = (imageContainerWidth*imgWidth)/productWidth + "px";
                            slideElem.style.width = (imageContainerWidth*imgWidth)/productWidth + "px";
                            var elemHeight = slideElem.height;
                            var topTrans = ((imgTop * 100)/imgHeight);
                            var croppedTop = ((topTrans * elemHeight)/100);
                            var bottomTrans = ((imgBottom * 100)/imgHeight);
                            var croppedBottom = ((bottomTrans * elemHeight)/100);
                            var actualHeight = (elemHeight - (croppedTop + croppedBottom));
                            var addBottom = (unitHeight - actualHeight)/2;
                            slideElem.style.bottom = (addBottom - croppedBottom) + "px";
                        
                        }else{
                            var elemHeight = slideElem.height;
                            var topTrans = ((imgTop * 100)/imgHeight);
                            var croppedTop = ((topTrans * elemHeight)/100);
                            var bottomTrans = ((imgBottom * 100)/imgHeight);
                            var croppedBottom = ((bottomTrans * elemHeight)/100);
                            slideElem.style.bottom = (imageBottom - croppedBottom) + "px";
                        }
                        var elemWidth = slideElem.height;
                        var rightTrans = ((imgRight * 100)/imgWidth);
                        var croppedRight = ((rightTrans * elemWidth)/100);
                        var rightval = (imageRight - croppedRight) + "px";
                        var leftTrans = ((imgLeft * 100)/imgWidth);
                        var croppedLeft = ((leftTrans * elemWidth)/100);
                        var actualWidth = (elemWidth - (croppedRight + croppedLeft));          
                        var restWidth = imageContainerWidth - actualWidth;
                        var addRight = restWidth / 2;
                        slideElem.style.marginLeft = ((imageRight - croppedLeft) + addRight) + "px";
                        slideElem.style.top = "auto";
                }
                    
                }else{
                    console.log('app____');
                    app_count.push(i);
                    var frame_val = i + 2,
                        frame_value = frame_val.toString(),
                        index_val = i + 1,
                        index_value = "_"+index_val.toString();
                    document.getElementById('frame'+frame_value).classList.add("girl");
                    document.getElementsByClassName('product'+index_value)[0].style.cssText += 'width:110px;height:auto;left:210px;';
                    document.getElementsByClassName('product'+index_value)[1].style.cssText += 'width:110px;height:auto;left:320px;';
                    document.getElementsByClassName('product'+index_value)[2].style.cssText += 'width:110px;height:auto;left:430px;';
                 //   document.getElementsByClassName('product'+index_value)[3].style.cssText += 'width:90px;height:auto;left:450px;';
                    document.getElementsByClassName('product'+index_value)[0].src = result[i]['Grey_image1'];
                    document.getElementsByClassName('product'+index_value)[1].src = result[i]['Grey_image2'];
                    document.getElementsByClassName('product'+index_value)[2].src = result[i]['Grey_image3'];
                 //   document.getElementsByClassName('product'+index_value)[3].src = result[i]['Grey_image4'];
                 document.getElementsByClassName("head")[i].innerHTML = dynamicData['NC_Head_CTA'][0]['Headline'];
                 if(ap_DataSignal7 == "russia_russian")
                 {
                     document.getElementsByClassName("head")[i].style.cssText+="font-size:9px";
                     document.getElementsByClassName("price")[i].style.cssText+="font-size:11px";  
                 }  
                 if(ap_DataSignal7 == "denmark_danish" || ap_DataSignal7 == "sweden_swedish"|| ap_DataSignal7 == "norway_norwegian")
                 {
                     document.getElementsByClassName("price")[i].style.cssText+="font-size:11px";  
                 } 
                 if(ap_DataSignal7 == "switzerland_english" || ap_DataSignal7 =="switzerland_french" || ap_DataSignal7 =="switzerland_german" ||ap_DataSignal7 =="switzerland_italian")
                 {
                     document.getElementsByClassName("price")[i].style.cssText+="font-size:10.5px;padding:0 1px";  
                 }
                 document.getElementsByClassName("cta")[i].innerHTML = dynamicData['NC_Head_CTA'][0]['CTA'];
                 if(ap_DataSignal7 == "spain_spanish" || ap_DataSignal7 == "spain_catalan")
                 {
                     document.getElementsByClassName("cta")[i].style.cssText+="font-size:9px;padding: 4px 5px 4.5px;";
                     document.getElementsByClassName("head")[i].style.cssText+="top:27px";
                 } 
                 if(ap_DataSignal7 == "germany_german" || ap_DataSignal7 == "austria_german" || ap_DataSignal7 == "belgium_german" || ap_DataSignal7 == "italy_italian" || ap_DataSignal7 == "switzerland_italian" || ap_DataSignal7 =="switzerland_german"  ||  ap_DataSignal7 =="belgium_german")
                 {
                     document.getElementsByClassName("cta")[i].style.cssText+="font-size:11px;padding: 3px 6px 4px;";
                     document.getElementsByClassName("head")[i].style.cssText+="top:28px";
                 } 
                 if(ap_DataSignal7 == "sweden_swedish")
                 {
                    document.getElementsByClassName("cta")[i].style.cssText+="font-size:11px;padding: 3px 6px 4px;";
                    document.getElementsByClassName("head")[i].style.cssText+="top:28px";
                 }
                  var mac = "Mac";
                  if(navigator.userAgent.indexOf(mac) > -1)
                  {
                     document.getElementsByClassName("cta")[i].style.cssText+="padding:3px 6px 4.5px";
                  }

                    var title_split = result[i]['style_line1'].split(" ");
                    var title_trim = result[i]['style_line1'].substring(0, app_titleChar);
                    var title_trim_1 = title_trim.split(" ");
                    var final_trim = [],
                        final_title_value = [];
                    if(title_trim_1.length > 0){
                        var trim_len = title_trim_1.length;
                        for(k=0;k<trim_len;k++){
                           final_trim.push(title_split[k]+" ");
                        }
                        var final_trim_V1 = final_trim.join(" ");
                        var final_trim_1 = final_trim_V1.trim();
                        if(final_trim_1.length > app_titleChar){
                            title_trim_1.pop();
                            for(l=0;l<title_trim_1.length;l++){
                               final_title_value.push(title_trim_1[l]+" ");
                            }
                            var ab___ = final_title_value.join(" ");
                            var final_title_val = ab___.trim();
                            console.log(result[i]['style_line1'].substring(0, app_titleChar),"____",final_title_val,"difference___app");
                            document.getElementsByClassName('title')[i].innerHTML = final_title_val;
                        }else{
                            document.getElementsByClassName('title')[i].innerHTML = result[i]['style_line1'].substring(0, app_titleChar);
                        }
                    }else{
                        document.getElementsByClassName('title')[i].innerHTML = result[i]['style_line1'].substring(0, app_titleChar);
                    }
                }

                var bg_v1 = result[i]['hexvalue_code'];
                if((typeof dynamicData != "undefined") && (typeof dynamicData['NC_BG_BW'] != "undefined") && (dynamicData['NC_BG_BW'].length >= 4)){
                    if(bg_v1 == "#f6f6f6"){
                        bg_v1 = dynamicData['NC_BG_BW'][i]["bg_color"];
                    }
                }
                colorReporting.push(bg_v1);
                product_colorReporting.push(result[i]['ID']+":"+bg_v1);
                
                console.log(priority,"priority_value_----------");
                if(priority == "RecentConverter"){
                    if((DYselectedGroup == "PROS_With_Headline") && (DYselectedRule=="PROS_WITH_AND_WITHOUT_HEADLINE_INITIAL")){
                        strategy = "RETARGETING|RE-ENGAGEMENT_WITH_HEADLINE_INITIAL";
                        default_strategy = "NA|NA";
                    }else if((DYselectedGroup == "PROS_With_Headline_SEQ") && (DYselectedRule=="PROS_WITH_HEADLINE_SEQ")){
                        strategy = "RETARGETING|RE-ENGAGEMENT_WITH_HEADLINE_SEQUENTIAL";
                        default_strategy = "NA|NA";
                    }else{
                        strategy = "RETARGETING|RE-ENGAGEMENT_WITH_HEADLINE";
                        default_strategy = "NA|NA";
                    }
                }else if(priority == "Retargeting"){
                    if((DYselectedGroup == "PROS_With_Headline") && (DYselectedRule=="PROS_WITH_AND_WITHOUT_HEADLINE_INITIAL")){
                        strategy = "RETARGETING|PDP_WITH_HEADLINE_INITIAL";
                        default_strategy = "NA|NA";
                    }else if((DYselectedGroup == "PROS_With_Headline_SEQ") && (DYselectedRule=="PROS_WITH_HEADLINE_SEQ")){
                        strategy = "RETARGETING|PDP_WITH_HEADLINE_SEQUENTIAL";
                        default_strategy = "NA|NA";
                    }else{
                        strategy = "RETARGETING|PDP_WITH_HEADLINE";
                        default_strategy = "NA|NA";
                    }
                }else if(priority == "UpsellConverter"){
                    if((DYselectedGroup == "PROS_With_Headline") && (DYselectedRule=="PROS_WITH_AND_WITHOUT_HEADLINE_INITIAL")){
                        strategy = "RETARGETING|CROSS_UPSELL_WITH_HEADLINE_INITIAL";
                        default_strategy = "NA|NA";
                    }else if((DYselectedGroup == "PROS_With_Headline_SEQ") && (DYselectedRule=="PROS_WITH_HEADLINE_SEQ")){
                        strategy = "RETARGETING|CROSS_UPSELL_WITH_HEADLINE_SEQUENTIAL";
                        default_strategy = "NA|NA";
                    }else{
                        strategy = "RETARGETING|CROSS_UPSELL_WITH_HEADLINE";
                        default_strategy = "NA|NA";
                    }    
                }else if(priority == "HomepageTargeting"){
                    if((DYselectedGroup == "PROS_With_Headline") && (DYselectedRule=="PROS_WITH_AND_WITHOUT_HEADLINE_INITIAL")){
                        strategy = "RETARGETING|HOMEPAGE_WITH_HEADLINE_INITIAL";
                        default_strategy = "NA|NA";
                    }else if((DYselectedGroup == "PROS_With_Headline_SEQ") && (DYselectedRule=="PROS_WITH_HEADLINE_SEQ")){
                        strategy = "RETARGETING|HOMEPAGE_WITH_HEADLINE_SEQUENTIAL";
                        default_strategy = "NA|NA";
                    }else{
                        strategy = "RETARGETING|HOMEPAGE_WITH_HEADLINE";
                        default_strategy = "NA|NA";
                    }    
                }else if(priority == "AudienceId"){
                    if((DYselectedGroup == "PROS_With_Headline") && (DYselectedRule=="PROS_WITH_AND_WITHOUT_HEADLINE_INITIAL")){
                        strategy = "RETARGETING|BEST_SELLER_WITH_HEADLINE_INITIAL";
                        default_strategy = "NA|NA";
                    }else if((DYselectedGroup == "PROS_With_Headline_SEQ") && (DYselectedRule=="PROS_WITH_HEADLINE_SEQ")){
                        strategy = "RETARGETING|BEST_SELLER_WITH_HEADLINE_SEQUENTIAL";
                        default_strategy = "NA|NA";
                    }else{
                        strategy = "RETARGETING|BEST_SELLER_WITH_HEADLINE";
                        default_strategy = "NA|NA";
                    }    
                }else if(priority == "LineItemIds"){
                    if((DYselectedGroup == "PROS_With_Headline") && (DYselectedRule=="PROS_WITH_AND_WITHOUT_HEADLINE_INITIAL")){
                        strategy = "PROSPECTING|BEST_SELLER_WITH_HEADLINE_INITIAL";
                        default_strategy = "NA|NA";
                    }else if((DYselectedGroup == "PROS_With_Headline_SEQ") && (DYselectedRule=="PROS_WITH_HEADLINE_SEQ")){
                        strategy = "PROSPECTING|BEST_SELLER_WITH_HEADLINE_SEQUENTIAL";
                        default_strategy = "NA|NA";
                    }else{
                        strategy = "PROSPECTING|BEST_SELLER_WITH_HEADLINE";
                        default_strategy = "NA|NA";
                    }    
                }else if(priority == "GeoLanguageDefault"){
                    if((DYselectedGroup == "PROS_With_Headline") && (DYselectedRule=="PROS_WITH_AND_WITHOUT_HEADLINE_INITIAL")){
                        strategy = "NA|NA_WITH_HEADLINE_INITIAL";
                        default_strategy = "DEFAULT|FALLBACK_DEFAULT";
                    }else if((DYselectedGroup == "PROS_With_Headline_SEQ") && (DYselectedRule=="PROS_WITH_HEADLINE_SEQ")){
                        strategy = "NA|NA_WITH_HEADLINE_SEQUENTIAL";
                        default_strategy = "DEFAULT|FALLBACK_DEFAULT";
                    }else{
                        strategy = "NA|NA_WITH_HEADLINE";
                        default_strategy = "DEFAULT|FALLBACK_DEFAULT";
                    }    
                }else if(priority == "BaseDefault"){
                    if((DYselectedGroup == "PROS_With_Headline") && (DYselectedRule=="PROS_WITH_AND_WITHOUT_HEADLINE_INITIAL")){
                        strategy = "NA|NA_WITH_HEADLINE_INITIAL";
                        default_strategy = "DEFAULT|MAIN_DEFAULT";
                    }else if((DYselectedGroup == "PROS_With_Headline_SEQ") && (DYselectedRule=="PROS_WITH_HEADLINE_SEQ")){
                        strategy = "NA|NA_WITH_HEADLINE_SEQUENTIAL";
                        default_strategy = "DEFAULT|MAIN_DEFAULT";
                    }else{
                        strategy = "NA|NA_WITH_HEADLINE";
                        default_strategy = "DEFAULT|MAIN_DEFAULT";
                    }    
                }else{
                    strategy = "NA|NA_WITH_HEADLINE";
                    default_strategy = "NA|NA";
                }
            
                if(ap_geoLang != "NA"){
                    geoValue = ap_geoLang.split("_")[0].replace(" ","_");;
                    langValue = ap_geoLang.split("_")[1];
                }else{
                    geoValue = "NA";
                    langValue = "NA";
                }
                var creativeTypeValue = {
                    3:"Mobile_Standard",
                    18:"IAB_Leaderboard",
                    19:"IAB_Wide_Skyscraper",
                    20:"IAB_Medium_Rectangle",
                    21:"IAB_Rectangle",
                    22:"IAB_Half Page",
                    29:"IAB_Billboard_Non-Expanding"
                }
                
                var asv_values = {
                    dspValue:"DBM",
                    deviceValue:dynamicData['device:device.model'],
                    creativeType:creativeTypeValue[creativeUnitType],
                    creativeSize:dynamicData['campaignProperties:campaignProperties.creativeDim'],
                    videoValue:"NA",
                    dvLineitemID:dynamicData['tagVarService:tagVarService.DataSignal1'],
                    dvAuctionID:dynamicData['tagVarService:tagVarService.DataSignal2'],
                    dvCreativeID:ap_DataSignal3,
                    dvSiteID:ap_DataSignal4,
                    cmPID:"NA",
                    cmAdID:"NA",
                    cmRenderID:"NA",
                    cmCreativeID:"NA",
                    cmSiteID:"NA",
                    otherDSPLineID:"NA",
                    otherDSPAuctionID:"NA",
                    otherDSPCreativeID:"NA",
                    otherDSPRefsiteTag:"NA",
                    otherDSPAID:"NA",
                    dspProductModelType:"FTW/APP",
                    messageID:"NA",
                    mindSetValue:"NA",
                    promotionVal:"NA"
                }
                 var assetVariantReportValues = strategy+"|"+geoValue+"|"+langValue+"|"+asv_values["dspValue"]+"|"+asv_values["deviceValue"]+"|"+asv_values["creativeType"]+"|"+asv_values["creativeSize"]+"|"+asv_values["videoValue"]+"|"+cat_Reporting.join(",")+"|"+gen_Reporting.join(",")+"|"+asv_values["dvLineitemID"]+"|"+asv_values["dvAuctionID"]+"|"+asv_values["dvCreativeID"]+"|"+asv_values["dvSiteID"]+"|"+asv_values["cmPID"]+"|"+asv_values["cmAdID"]+"|"+asv_values["cmRenderID"]+"|"+asv_values["cmCreativeID"]+"|"+asv_values["cmSiteID"]+"|"+asv_values["otherDSPLineID"]+"|"+asv_values["otherDSPAuctionID"]+"|"+asv_values["otherDSPCreativeID"]+"|"+asv_values["otherDSPRefsiteTag"]+"|"+asv_values["otherDSPAID"]+"|"+productReporting.join(',')+"|"+colorReporting.join(",")+"|"+cv_no+"|"+asv_values["dspProductModelType"]+"|"+modeltypeReporting.join(",")+"|"+default_strategy+"|"+asv_values["messageID"]+"|"+asv_values["mindSetValue"]+"|"+asv_values["promotionVal"];

            }
            
            _jvxAd.recordAssetVariation("impression", assetVariantReportValues);
            console.log(ftw_count.length,app_count.length,"length",ftw_count,app_count);
            document.getElementsByClassName('intro_text')[0].innerHTML = result[0]['Framecopy_1'];
            if(ap_DataSignal7 == "russia_russian" || ap_DataSignal7 == "greece_greek")
            {
                document.getElementsByClassName('intro_text')[0].style.cssText +="font-family:HelveticaWorld;word-spacing:-3px"; 
            }
            



            for(i_=0;i_<widget.defaults.numberOfProducts;i_++){
                var price = result[i_]['Price'],
                    salePrice = result[i_]['SalePrice'], 
                    salePercentage = result[i_]['sale_percentage'];
            
                if(price == salePrice && salePercentage=='0%'){
                    document.getElementsByClassName('price')[i_].innerHTML = result[i_]['Price'];
                }else{
                    if((price.charAt(0) == "£") || (price.charAt(0) == "$")){
                        var firstChar = price.charAt(0),
                            subPrice = price.substring(1, price.length);   
                            document.getElementsByClassName("price")[i_].innerHTML = firstChar + subPrice.strike() + "&nbsp &nbsp"+salePrice;
                    }else{
                        var salePriceCheck = price.split(" ")[1],
                             checkVal = salePriceCheck.charAt(0),
                             reg = new RegExp('^[0-9]+$'),
                             val = reg.test(checkVal);
                         if(val == true){
                            document.getElementsByClassName("price")[i_].innerHTML = price.split(" ")[0] + " " + price.split(" ")[1].strike() +"&nbsp &nbsp"+salePrice;
                         }else{
                             document.getElementsByClassName("price")[i_].innerHTML = price.strike() +"&nbsp &nbsp"+salePrice; 
                        }
                    }
                   if((typeof dynamicData != "undefined") && (typeof dynamicData['NC_LABEL_FD'] != "undefined") && (dynamicData['NC_LABEL_FD'].length >= 1)){
                        var label_val = dynamicData['NC_LABEL_FD'][0]['saleCopy'];
                        var label_val_pos = dynamicData['NC_LABEL_FD'][0]['position_text'];
                        var saleValue = result[i_]['sale_percentage'];
                        var saleValue_re = saleValue.replace("%", "");
                        var saleValue_int = parseInt(saleValue_re);
                        var sale_percentage_final = round5(saleValue_int);
                        var sale_final_percentage = sale_percentage_final+"%";
                        if(sale_percentage_final > 5){
                            if(label_val_pos == 'Front'){
                                document.getElementsByClassName('sale_corner')[i_].innerHTML = label_val +'<br>'+sale_final_percentage;
                                document.getElementsByClassName('sale_corner')[i_].style.cssText += "font-size:10px;line-height:9.5px";
                            }else if(label_val_pos == 'Back'){
                                document.getElementsByClassName('sale_corner')[i_].innerHTML = sale_final_percentage +'<br>'+ label_val;
                                document.getElementsByClassName('sale_corner')[i_].style.cssText += "font-size:10px;line-height:9.5px";
                            }else{
                                document.getElementsByClassName('sale_corner')[i_].innerHTML = "-"+sale_final_percentage;
                                document.getElementsByClassName('sale_corner')[i_].style.cssText += "font-size:13px";
                               // document.getElementsByClassName('sale_push')[i_].style.cssText += "padding-top:10px";
                            }
                            if(label_val.length>=5){
                             //   document.getElementsByClassName('sale_push')[i_].style.cssText += "right:1px";
                                var el = document.getElementsByClassName('sale_corner')[i_];
                                var elNewFontSize = (parseInt($(el).css('font-size').slice(0, -2)) - 2) + 'px';
                                var elNewLineHeight = (parseInt($(el).css('font-size').slice(0, -2)) - 1) + 'px';
                                $(el).css('font-size', "8.5px");
                                $(el).css('line-height', "9px");
                            }
                        }
                    }else{
                        document.getElementsByClassName('sale_corner')[i_].innerHTML = 'SAVE' +'<br>'+result[i_]['sale_percentage'];
                    }
                }

            }
            
            var bg_1 = result[0]['hexvalue_code'];
            var bg_2 = result[1]['hexvalue_code'];
            var bg_3 = result[2]['hexvalue_code'];
            var bg_4 = result[3]['hexvalue_code'];
            var bg_1_dark = result[0]['Dark'];
            var bg_1_light = result[0]['Light'];
            var bg_2_dark = result[1]['Dark'];
            var bg_2_light = result[1]['Light'];
            var bg_3_dark = result[2]['Dark'];
            var bg_3_light = result[2]['Light'];
            var bg_4_dark = result[3]['Dark'];
            var bg_4_light = result[3]['Light'];
            console.log(bg_1_dark,bg_1_light,'bg_color');
    
            if((typeof dynamicData != "undefined") && (typeof dynamicData['NC_BG_GRA'] != "undefined") && (dynamicData['NC_BG_GRA'].length >= 4)){
                if(bg_1 == "#f6f6f6"){
                    bg_1_dark = dynamicData['NC_BG_GRA'][0]["Dark"];
                    bg_1_light = dynamicData['NC_BG_GRA'][0]["Light"]; 
                }
                if(bg_2 == "#f6f6f6"){
                    bg_2_dark = dynamicData['NC_BG_GRA'][1]["Dark"];
                    bg_2_light = dynamicData['NC_BG_GRA'][1]["Light"]; 
                }
                if(bg_3 == "#f6f6f6"){
                    bg_3_dark = dynamicData['NC_BG_GRA'][2]["Dark"];
                    bg_3_light = dynamicData['NC_BG_GRA'][2]["Light"]; 
                }
                if(bg_4 == "#f6f6f6"){
                    bg_4_dark = dynamicData['NC_BG_GRA'][3]["Dark"];
                    bg_4_light = dynamicData['NC_BG_GRA'][3]["Light"]; 
                }
            }
            
            document.getElementById('frame2').style.cssText += 'background:linear-gradient(to right,'+bg_1_light+' 0%,'+bg_1_dark+' 100%)';
            document.getElementById('frame3').style.cssText += 'background:linear-gradient(to right,'+bg_2_light+' 0%,'+bg_2_dark+' 100%)';
            document.getElementById('frame4').style.cssText += 'background:linear-gradient(to right,'+bg_3_light+' 0%,'+bg_3_dark+' 100%)';
            document.getElementById('frame5').style.cssText += 'background:linear-gradient(to right,'+bg_4_light+' 0%,'+bg_4_dark+' 100%)';
        setTimeout(function(){
            console.log("comming-------1");
            JIVOX.app.init();  
        }, 1000);

        var anchor_reAs_2 = document.getElementById('frame2');
        var attValAs_2 = document.createAttribute("data-val");
            attValAs_2.value = ap_geoLang+"_"+result[0]["ID"]+"_NonInteraction";
            anchor_reAs_2.setAttributeNode(attValAs_2);
        var anchor_reAs_3 = document.getElementById('frame3');
        var attValAs_3 = document.createAttribute("data-val");
            attValAs_3.value = ap_geoLang+"_"+result[1]["ID"]+"_NonInteraction";
            anchor_reAs_3.setAttributeNode(attValAs_3);
        var anchor_reAs_4 = document.getElementById('frame4');
        var attValAs_4 = document.createAttribute("data-val");
            attValAs_4.value = ap_geoLang+"_"+result[2]["ID"]+"_NonInteraction";
            anchor_reAs_4.setAttributeNode(attValAs_4);
        var anchor_reAs_5 = document.getElementById('frame5');
        var attValAs_5 = document.createAttribute("data-val");
            attValAs_5.value = ap_geoLang+"_"+result[3]["ID"]+"_NonInteraction";
            anchor_reAs_5.setAttributeNode(attValAs_5);

        var pros_align_check = "Prospecting";

        var anchor_ = document.getElementsByClassName('container')[0];
        var attVal_ = document.createAttribute("data-value");
            attVal_.value = pros_align_check;
            anchor_.setAttributeNode(attVal_);

		document.getElementById('frame1').addEventListener("click", function(e) {
            e.stopPropagation();
            var URL_ = result[0]['urls'];
            jvxAd.openClickThrough(URL_);
        },false);

        document.getElementById('frame2').addEventListener("click", function(e) {
            e.stopPropagation();
            jvxAd.recordAssetVariation("click", assetVariantReportValues);
            jvxAd.recordEventByName(ap_geoLang+"_"+result[0]["ID"]+"_Interaction", 1);
            var URL_ = result[0]['URL'];
            jvxAd.openClickThrough(URL_);
        },false);
        document.getElementById('frame3').addEventListener("click", function(e) {
            e.stopPropagation();
            jvxAd.recordAssetVariation("click", assetVariantReportValues);
            jvxAd.recordEventByName(ap_geoLang+"_"+result[1]["ID"]+"_Interaction", 1);
            var URL_ = result[1]['URL'];
            jvxAd.openClickThrough(URL_);
        },false);
        document.getElementById('frame4').addEventListener("click", function(e) {
            e.stopPropagation();
            jvxAd.recordAssetVariation("click", assetVariantReportValues);
            jvxAd.recordEventByName(ap_geoLang+"_"+result[2]["ID"]+"_Interaction", 1);
            var URL_ = result[2]['URL'];
            jvxAd.openClickThrough(URL_);
        },false);
        document.getElementById('frame5').addEventListener("click", function(e) {
            e.stopPropagation();
            jvxAd.recordAssetVariation("click", assetVariantReportValues);
            jvxAd.recordEventByName(ap_geoLang+"_"+result[3]["ID"]+"_Interaction", 1);
            var URL_ = result[3]['URL'];
            jvxAd.openClickThrough(URL_);
        },false);
        
        };
        
        this.getDSPCatProducts = function(result) {
            console.log("Result123",result);
            if (Object.keys(result).length > 0 && result['NC_CAT_FD:NC_CAT_FD'].length >= widget.defaults.numberOfProducts) {
                console.log('getDSPCatProductsz : ', result, result['NC_CAT_FD:NC_CAT_FD']);

                result = result[Object.keys(result)[0]];
                console.log('getDSPCatProducts result : ', result);
                for (var key in result) {
                    productSet.push(result[key]);
                }
               console.log('productSetCat : ',productSet, productSet.slice(0, 4), productSet.length, typeof productSet); 
                
                self.generateGallery(productSet.slice(0, widget.defaults.numberOfProducts),"LineItemIds_"+result[0]['Category'].toLowerCase()+"_"+ap_geoLang+"-"+ap_DataSignal1,"LineItemIds_"+result[0]['Category'].toLowerCase()+"_"+ap_geoLang); 
            } else {
                self.callGeoLangDefaults(ap_geoLang + "_default");
            }
        }
        
        this.getCatogoryProducts = function(result) {
            if (Object.keys(result).length > 0 && result['NC_GEN_FD:NC_GEN_FD'].length >= widget.defaults.numberOfProducts) {
                console.log("Category Youth four");
                result = result[Object.keys(result)[0]];
                for (var key in result) {
                    productSet.push(result[key]);
                }
                var template_value = dynamicData['NC_AID_RET'][0]['Template'];
                    if(template_value == "CategoryProspecting"){
                        var audienceIdReport = "LineItemIds_";
                    }else{
                        var audienceIdReport = "AudienceId_";
                    }
                    var aid_value = dynamicData['NC_AID_RET'][0]['Reporting'];
                    console.log(aid_value,"DS2_Val");
                    if(aid_value == "172846969" || aid_value == "245899369" || aid_value == "259539049"){
                        var audienceIdReport = "HomepageTargeting_";
                    }
                    self.generateGallery(productSet.slice(0, widget.defaults.numberOfProducts),audienceIdReport+result[0]['Gender'].toLowerCase()+"_"+result[0]['model_type'].toLowerCase()+"_"+result[0]['Category'].toLowerCase()+"_"+ap_geoLang+"-"+ap_DataSignal1,audienceIdReport+result[0]['Gender'].toLowerCase()+"_"+result[0]['model_type'].toLowerCase()+"_"+result[0]['Category'].toLowerCase()+"_"+ap_geoLang)
            }else if ((self.getDynamicData('tagVarService:tagVarService.DataSignal1')) && (ap_geoLang !== "NA_NA")&& (typeof dynamicData != "undefined") && (typeof dynamicData['NC_LID_RE'] != "undefined") && (dynamicData['NC_LID_RE'].length >= 1) && (dynamicData['NC_LID_RE'][0]['category']!="") &&(ap_DataSignal8 == "undefined")&& (ap_DataSignal1 != "${CAMPAIGN_ID}")) {
                console.log('Prospecting DCM Id available | Priority 3', self.getDynamicData('tagVarService:tagVarService.DataSignal1'));
                var dspDS1_val = dynamicData['NC_LID_RE'][0]['category'].toLowerCase();
                var dspDS1 = self.getDynamicData('tagVarService:tagVarService.DataSignal1');
                self.validateDSPId(dspDS1_val);
            }else{
                console.log("call_for_default_no_match");
                 self.callGeoLangDefaults(ap_geoLang + "_default");
            }
        }
        
        this.getaudienceSet = function(result) {
            console.log("Result123",result);
            //console.log('getaudienceSetz : ', result, result['NC_AID_FD:NC_AID_FD'].length);
            if (Object.keys(result).length > 0 && result['NC_AID_FD:NC_AID_FD'].length > 0) {
                result = result[Object.keys(result)[0]];
                console.log('getaudienceSetx result : ', result);
                for (var key in result) {
                    productSet.push(result[key]);
                }
                if(productSet.length >= widget.defaults.numberOfProducts){
                    console.log("Category Greater than four");
                    var template_value = dynamicData['NC_AID_RET'][0]['Template'];
                    if(template_value == "CategoryProspecting"){
                        var audienceIdReport = "LineItemIds_";
                    }else{
                        var audienceIdReport = "AudienceId_";
                    }
                    var aid_value = dynamicData['NC_AID_RET'][0]['Reporting'];
                    console.log(aid_value,"DS2_Val");
                    if(aid_value == "172846969" || aid_value == "245899369" || aid_value == "259539049"){
                        var audienceIdReport = "HomepageTargeting_";
                    }
                    self.generateGallery(productSet.slice(0, widget.defaults.numberOfProducts),audienceIdReport+result[0]['Gender'].toLowerCase()+"_"+result[0]['model_type'].toLowerCase()+"_"+result[0]['Category'].toLowerCase()+"_"+ap_geoLang+"-"+ap_DataSignal1,audienceIdReport+result[0]['Gender'].toLowerCase()+"_"+result[0]['model_type'].toLowerCase()+"_"+result[0]['Category'].toLowerCase()+"_"+ap_geoLang)
                }else{
                    console.log("Category less than four");
                    if(productSet[0]['Gender']=="YOUTH"){
                        console.log("Category less than four Youth");
                        self.dynamicDataCallback("NC_GEN_FD", ap_geoLang + "_youth", "getCatogoryProducts");
                    }else{
                        console.log("Category less than four other");
                        if((self.getDynamicData('tagVarService:tagVarService.DataSignal1')) && (ap_geoLang !== "NA_NA")&& (typeof dynamicData != "undefined") && (typeof dynamicData['NC_LID_RE'] != "undefined") && (dynamicData['NC_LID_RE'].length >= 1) && (dynamicData['NC_LID_RE'][0]['category']!="") &&(ap_DataSignal8 == "undefined")&& (ap_DataSignal1 != "${CAMPAIGN_ID}")) {
                            console.log('Prospecting DCM Id available | Priority 3', self.getDynamicData('tagVarService:tagVarService.DataSignal1'));
                            var dspDS1_val = dynamicData['NC_LID_RE'][0]['category'].toLowerCase();
                            var dspDS1 = self.getDynamicData('tagVarService:tagVarService.DataSignal1');
                            self.validateDSPId(dspDS1_val);
                        }else{
                            console.log("call_for_default_no_match");
                             self.callGeoLangDefaults(ap_geoLang + "_default");
                        }
                    }
                }    
            }else if ((self.getDynamicData('tagVarService:tagVarService.DataSignal1')) && (ap_geoLang !== "NA_NA")&& (typeof dynamicData != "undefined") && (typeof dynamicData['NC_LID_RE'] != "undefined") && (dynamicData['NC_LID_RE'].length >= 1) && (dynamicData['NC_LID_RE'][0]['category']!="") &&(ap_DataSignal8 == "undefined")&& (ap_DataSignal1 != "${CAMPAIGN_ID}")) {
                console.log('Prospecting DCM Id available | Priority 3', self.getDynamicData('tagVarService:tagVarService.DataSignal1'));
                var dspDS1_val = dynamicData['NC_LID_RE'][0]['category'].toLowerCase();
                var dspDS1 = self.getDynamicData('tagVarService:tagVarService.DataSignal1');
                self.validateDSPId(dspDS1_val);
            } else{
                console.log("call_for_default_no_match");
                 self.callGeoLangDefaults(ap_geoLang + "_default");
            }
            
        }
       
        this.getGeoLangDefaults = function(result) {
            console.log("Result123",result);
            //console.log('getGeoLangDefaultsz : ', result, result['NC_DEF_FD:NC_DEF_FD'], result['NC_DEF_FD:NC_DEF_FD'].length); 
            if ((Object.keys(result).length > 0) && (result['NC_DEF_FD:NC_DEF_FD'].length >= widget.defaults.numberOfProducts) && (ap_geoLang !== "NA_NA")) { //wips changed
                result = result[Object.keys(result)[0]];
                console.log('getGeoLangDefaultsx result : ', result);
                for (var key in result) {
                    productSet.push(result[key]);
                }
                self.generateGallery(productSet.slice(0, widget.defaults.numberOfProducts),"GeoLanguageDefault"+"_"+ap_geoLang+"-"+ap_DataSignal1,"GeoLanguageDefault"+"_"+ap_geoLang);
            } else {
                console.log('Geo Lang def not found. Call base default'); 
                self.dynamicDataCallback("NC_DEF_FD", "_default_", "loadDefault");
            }
        }
        this.loadDefault = function(result) {
            console.log('Base default loaded', result);
            result = result[Object.keys(result)[0]];
            console.log('Base default resultx : ', result);
            for (var key in result) {
                productSet.push(result[key]);
            }
            self.generateGallery(productSet.slice(0, widget.defaults.numberOfProducts),"BaseDefault"+"_"+ap_geoLang,"BaseDefault"+"_"+ap_geoLang);
        };
        this.validateAudienceId = function(id) {
            console.log('validateAudienceId loaded', id, id.length);
            var audienceSet = ap_geoLang + "_" + id;
            self.dynamicDataCallback("NC_AID_FD", audienceSet, "getaudienceSet");
        };
        this.validateDSPId = function(dspid) {
            console.log('validateDSPId loaded', dspid);
            if(ap_bestsellerID == "bestseller"){
                console.log("BestSeller_Logic_ID",ap_bestsellerID);
                var catDBTrigger = ap_geoLang + "_" + dspid+ "_bestseller";
            }else{
                var catDBTrigger = ap_geoLang + "_" + dspid;
            }
            self.dynamicDataCallback("NC_CAT_FD", catDBTrigger, "getDSPCatProducts");
        };
        this.callGeoLangDefaults = function(result) {
            console.log('callGeoLangDefaults loadedx', result);
            self.dynamicDataCallback("NC_DEF_FD", result,"getGeoLangDefaults");
        };
        this.init = function() {
            //document.getElementsByTagName('body')[0].style.opacity = 0;
            _root["getaudienceSet"] = self.getaudienceSet;
            _root["getCatogoryProducts"] = self.getCatogoryProducts;
            _root["getDSPCatProducts"] = self.getDSPCatProducts;
            _root["getGeoLangDefaults"] = self.getGeoLangDefaults;
            _root["loadDefault"] = self.loadDefault;
            
            

            console.log('Init called');
            console.log(ap_bestsellerID,ap_DataSignal1,"DS_Values");
            if ((ap_geoLang !== "NA_NA")&& (typeof dynamicData != "undefined") && (typeof dynamicData['NC_AID_RET'] != "undefined") && (dynamicData['NC_AID_RET'].length >= 1) && (dynamicData['NC_AID_RET'][0]['Reporting'] != "No Audience ID")) {  
                console.log('Audience Id available | Priority 2', dynamicData['NC_AID_RET'][0]['Reporting']);
                var dspDS2 = dynamicData['NC_AID_RET'][0]['Reporting'];
                console.log(dspDS2,"dspDS2");
                self.validateAudienceId(dspDS2);
            }else if ((self.getDynamicData('tagVarService:tagVarService.DataSignal1')) && (ap_geoLang !== "NA_NA")&& (typeof dynamicData != "undefined") && (typeof dynamicData['NC_LID_RE'] != "undefined") && (dynamicData['NC_LID_RE'].length >= 1) && (dynamicData['NC_LID_RE'][0]['category']!="") && (ap_DataSignal8 == "undefined")&& (ap_DataSignal1 != "${CAMPAIGN_ID}")) { 
                console.log('Prospecting DCM Id available | Priority 3', self.getDynamicData('tagVarService:tagVarService.DataSignal1'));
                var dspDS1_val = dynamicData['NC_LID_RE'][0]['category'].toLowerCase();
                var dspDS1 = self.getDynamicData('tagVarService:tagVarService.DataSignal1');
                self.validateDSPId(dspDS1_val);
            }else if ((ap_geoLang !== "NA_NA")) { 
                console.log('ap_geoLang matching | Priority 4', ap_geoLang);
                self.callGeoLangDefaults(ap_geoLang + "_default");
            } else { 
                console.log('Base default loaded | Priority 5');
                self.dynamicDataCallback("NC_DEF_FD", "_default_", "loadDefault");
            }
        };
        
        
    }).apply(widget);
    _root["initiate"] = widget.init;
}(window, jvxAd, dynamicData));